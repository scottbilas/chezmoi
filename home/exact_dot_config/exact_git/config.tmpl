# SETUP
#

# until i get a reliable setup for ssh git on windows without wsl, here is how
# i do it now.
#
# 1. ensure can ssh into machine
# 2. ensure posh set as system shell, or the quoting that git does will get screwed up in arg processing. pssetup script has a check for this.
# 3. per repo...
#    a. `g remote add mymachine machine:C:/path/to/repo
#    b. `g config remote.mymachine.uploadpack (resolve-path ~/scoop/apps/git/current/mingw64/bin/git-upload-pack.exe)

;        _ _
;   __ _| (_) __ _ ___  ___  ___
;  / _` | | |/ _` / __|/ _ \/ __|
; | (_| | | | (_| \__ \  __/\__ \
;  \__,_|_|_|\__,_|___/\___||___/

[alias]
    unstage = reset HEAD --
    last = log -1 HEAD

    wt = worktree
    wtl = worktree list
    wts = "!f() { git worktree list | while read -r line; do dir=${line%*  *}; echo "$(tput setaf 4)${line%* [*}$(tput sgr 0)"; git -C $dir status -sb; echo ""; done }; f"
    # TODO: make this also go and do a `submodule update` on the new worktree
    wta = -c "submodule.recurse=" worktree add
    wtz = !dir=$(git root) && git co origin/master -B "z/$(basename "$dir")" --no-track
    dad = !curl https://icanhazdadjoke.com/ && echo "" && git add

    co = checkout
    fc = clone --recurse --jobs 7
    ss = stash show -p

    b  = branch -vv
    c  = commit
    d  = diff
    f  = fetch
    h  = help
    i  = incoming
    o  = outgoing
    # `npm i -g https://github.com/scottbilas/gitree`
    s  = !gitree -mcdn
    st = status

    p = pull --ff-only

    # "pull head" - automates `git pull <tracking remote> <current branch name>` so can get current on latest branch without pulling a whole (or the wrong) remote
    ph = "!f() { set -e; set -o pipefail; arr=($(git rev-parse --abbrev-ref @{u} | sed 's/\\//\\n/')); git pull ${arr[0]} ${arr[1]}; }; f"
    # get current while migrating current work
    prs = pull --rebase --autostash
    # pull before pushing
    sync = !git prs && git push

    outgoing = !git fetch && git l FETCH_HEAD..
    incoming = !git fetch && git l ..FETCH_HEAD

    dd = difftool --dir-diff
    sui = submodule update --init

    t = l0 --max-count=15
    t2 = l0 --max-count=30
    l0 = log --pretty=shortlog
    l = log --graph --pretty=shortlog-graph
    ll = log --graph --stat='100,0,20' --stat-graph-width=20 --pretty=longlog
    rl = reflog --pretty=reflog

    patch = !git --no-pager diff --no-color
    root = rev-parse --show-toplevel

    trash = !git add -A && git commit -m 'TRASH' && git reset --hard HEAD^

    # https://www.erikschierboom.com/2020/02/17/cleaning-up-local-git-branches-deleted-on-a-remote/
    gone = ! "git fetch -p && git for-each-ref --format '%(refname:short) %(upstream:track)' | awk '$2 == \"[gone]\" {print $1}'"
    rm-gone = ! "git gone | xargs -r git branch -D"

    # make a new commit from root containing the whole tree (https://stackoverflow.com/a/23486788/14582)
    squash-all = ! "git reset $(git commit-tree HEAD^{tree} -m 'Initial commit')"

    # easily get into git environment for testing
    sh = !sh

    {{ if eq .chezmoi.os "windows" -}}
    # https://stackoverflow.com/a/54322798/14582
    h = "!f() { $SYSTEMROOT/System32/bash -c \"git help $1\"; }; f"
    {{- end }}


;   ___ ___  _ __ ___
;  / __/ _ \| '__/ _ \
; | (_| (_) | | |  __/
;  \___\___/|_|  \___|

[core]
    autocrlf = input
    editor = micro
    eol = lf
    excludesfile = ~/.config/git/ignore
    fsmonitor = true
    hideDotFiles = false
    # longPaths = true   # not recommended to keep this on in general, only use on demand
    pager = delta
    symlinks = true

[credential]
    modalprompt = false

[fetch]
    prune = true

[init]
	defaultBranch = dev

[log]
    follow = true

[pull]
    rebase = merges

[push]
    default = simple

[rebase]
    autosquash = true

[rerere]
    enabled = true

[submodule]
    fetchJobs = 4
    # this is convenient, but causes way too many problems
    # (like `reset` or `checkout` ruining the .git:gitdir of the submodule when working with worktrees and extensions.worktreeConfig=true)
    #recurse = true


;            _                 _
;   _____  _| |_ ___ _ __  ___(_) ___  _ __  ___
;  / _ \ \/ / __/ _ \ '_ \/ __| |/ _ \| '_ \/ __|
; |  __/>  <| ||  __/ | | \__ \ | (_) | | | \__ \
;  \___/_/\_\\__\___|_| |_|___/_|\___/|_| |_|___/

[extensions]
    # https://patchwork.kernel.org/patch/10765697/
    worktreeConfig = true

[filter "lfs"]
    clean = git-lfs clean -- %f
    process = git-lfs filter-process
    smudge = git-lfs smudge -- %f
    required = true


;  _   _
; | |_| |__   ___ _ __ ___   ___
; | __| '_ \ / _ \ '_ ` _ \ / _ \
; | |_| | | |  __/ | | | | |  __/
;  \__|_| |_|\___|_| |_| |_|\___|

[advice]
    statusHints = false
    detachedHead = false

[color]
    ui = true
[color "branch"]
    upstream = cyan
[color "diff"]
    commit = yellow bold
    frag = magenta
    meta = yellow
    new = green bold
    old = red bold
    whitespace = red reverse
[color "diff-highlight"]
    oldHighlight = red bold 52
    oldNormal = red bold
    newHighlight = green bold 22
    newNormal = green bold

[pretty]
    longlog = ___%n   \\%n%C(auto)%d%Creset %s%n%C(bold cyan)% ae %Cblue(%cr) %C(bold black)%h
    reflog = %C(auto)%h %<|(20)%gd %C(blue)%cr%C(reset) %gs (%s)
    # TODO: base these on term width
    shortlog = %C(auto)%d%Creset %<|(70,trunc)%s%C(bold cyan)%<(18,trunc)% ae %Cblue(%cr) %C(bold black)%h
    shortlog-graph = %<|(10) %C(auto)%d%Creset %<|(70,trunc)%s%C(bold cyan)%<(18,trunc)% ae %Cblue(%cr) %C(bold black)%h

[status]
    showUntrackedFiles = all


;      _ _  __  __
;   __| (_)/ _|/ _|  _ __ ___   ___ _ __ __ _  ___
;  / _` | | |_| |_  | '_ ` _ \ / _ \ '__/ _` |/ _ \
; | (_| | |  _|  _| | | | | | |  __/ | | (_| |  __/
;  \__,_|_|_| |_|   |_| |_| |_|\___|_|  \__, |\___|
;                                       |___/

### COMMON ###

[diff]
    algorithm = histogram
    color-moved = default
    mnemonicprefix = true
    renames = copies

[interactive]
    diffFilter = delta --color-only --features=interactive

[merge]
    renamelimit = 50000
    stat = true

### PLATFORM ###

{{ if eq .chezmoi.os "windows" -}}
{{   if get .profile "beyond_compare_dirf" -}}
[diff]
    tool = bc
    prompt = false
[difftool]
    prompt = false
[difftool "bc"]
#   cmd = "set"   # uncomment to detect env vars
    cmd = {{.profile.home_dirf}}/.config/beyondcompare/bcomp-gitdd.cmd "$LOCAL" "$REMOTE"

[merge]
    tool = bc
    prompt = false
[mergetool "bc"]
    path = {{.profile.beyond_compare_dirf}}/BComp.exe
{{-   else if lookPath "code" -}}
[merge]
    tool = code
[mergetool "code"]
    cmd = code --wait --merge $REMOTE $LOCAL $BASE $MERGED
{{-   end -}}
{{- else -}}
[diff]
    tool = vimdiff3
[difftool "vimdiff3"]
#   path = nvim
[merge]
    tool = vimdiff3
[mergetool "vimdiff3"]
#   path = nvim
{{- end }}


;            _                        _
;   _____  _| |_ ___ _ __ _ __   __ _| |
;  / _ \ \/ / __/ _ \ '__| '_ \ / _` | |
; |  __/>  <| ||  __/ |  | | | | (_| | |
;  \___/_/\_\\__\___|_|  |_| |_|\__,_|_|

### DELTA ###

[include]
    path = ~/.config/git/delta-themes.gitconfig
[delta]
    features = collared-trogon
    side-by-side = true

### TIG ###

[tig]
#   diff-highlight = true  # not currently avail w termux
    horizontal-scroll = 10
    ignore-case = smart-case
    line-graphics = utf-8
    main-view = id date:relative-compact author:email-user commit-title:graph=v2,refs=yes
    mouse = true
    refresh-mode = auto
    tab-size = 4

;             _            _
;  _ __  _ __(_)_   ____ _| |_ ___
; | '_ \| '__| \ \ / / _` | __/ _ \
; | |_) | |  | |\ V / (_| | ||  __/
; | .__/|_|  |_| \_/ \__,_|\__\___|
; |_|

[user]
    # https://orrsella.com/2013/08/10/git-using-different-user-emails-for-different-repositories/
    useConfigOnly = true

[include]
    path = ~/.local/share/private/git/config
